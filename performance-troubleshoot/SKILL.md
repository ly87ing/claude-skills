---
name: performance-troubleshoot
description: Diagnoses Java performance issues including slow response, high CPU, memory spikes, OOM, GC pressure, resource exhaustion, service unavailable, and message backlog. Use when user reports 响应慢, CPU高, 内存暴涨, 内存溢出, GC频繁, 连接池满, 线程池满, 服务不可用, 超时, 错误率高, 消息积压, or needs 性能排查/性能分析.
---

# Java 性能问题排查 Skill

## 信息收集 (混合模式)

### 快速模式 (用户一次性提供完整信息)
若用户已提供以下信息，**直接进入分析**：
- ✅ 代码路径
- ✅ 症状描述 (内存/CPU/响应慢等)

**示例**: "请排查 `/path/to/project`，内存从 3GB 涨到 16GB"

### 引导模式 (信息不足时逐步询问)
若用户仅说 "帮我看性能"，按以下顺序**最多问 2 次**：

**第 1 问 (必问)**:
```
请提供：
1. Java 项目路径
2. 症状 (内存暴涨/CPU高/响应慢/资源耗尽/消息积压/不确定)
```

**第 2 问 (可选，仅当需要时)**:
根据症状追问辅助物料：
| 症状 | 追问 |
|------|------|
| 内存/OOM | 有 Heap Dump 或 GC 日志吗？ |
| CPU 高 | 有 Thread Dump 或火焰图吗？ |
| 响应慢 | 有 Trace 日志或 APM 数据吗？ |
| 其他 | 无需追问，直接分析代码 |

> **原则**: 最多 2 轮问答，能分析就分析，不要过度追问。

---

## 分析流程

1. **输入验证**：验证路径可访问
2. **分析策略**：
   - **自顶向下**：从各类流量入口 (Web/RPC/Message/Job/Socket) 开始追踪核心路径。
   - **智能分析**：优先使用 LSP/语义分析，追踪逻辑流而非仅匹配文本。
3. **未发现问题时**：若代码无明显缺陷，**必须**建议检查：DB 索引/锁、网络延迟、各级缓存命中率、JVM 配置。
4. **生成报告**：按 [TEMPLATE.md](TEMPLATE.md) 输出

---

## 问题类型与检查项

根据症状选择检查项（来自 [CHECKLIST.md](CHECKLIST.md)）：

| 问题类型 | 必查章节 | 关键检查点 |
|----------|----------|------------|
| **OOM/内存** | `[0]`, `[5]`, `[7]` | 放大效应、无界缓存、资源泄露 |
| **CPU 高** | `[0]`, `[1]`, `[2]` | 放大效应、锁竞争、循环计算 |
| **响应慢** | `[2]`, `[3]`, `[12]` | IO阻塞、下游超时、连接池 |
| **资源耗尽** | `[5]`, `[7]`, `[12]` | 连接池、线程池、句柄泄露 |
| **消息积压** | `[0]`, `[4]`, `[11]` | 消费能力、背压、Mailbox |

> **⚠️ 重要**：OOM/CPU/消息积压必须首先执行 CHECKLIST 章节 [0] 放大效应追踪。

---

## 输出标准

**每个发现的问题必须包含**：
1. **精确位置**：文件:行号
2. **量化数据**：调用次数、放大倍数
3. **具体优化代码**：可直接应用

**禁止**：
- 模糊描述（"多处调用"、"可能存在"）
- 通用建议（"建议优化"、"考虑缓存"）

---

## 报告输出

使用 `write_file` 保存报告，格式见 [TEMPLATE.md](TEMPLATE.md)。
